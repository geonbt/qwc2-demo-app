# QWC2 configuration

The layout of the development tree is as follows:

| Path                      | Description
|---------------------------|-------------------------------------------------------------------|
|`├─ assets/`               |                                                                   |
|`│  ├─ css/qwc2.css`       | Master style sheet                                                |
|`│  ├─ img/`               | Application logo                                                  |
|`│  │  └─ mapthumbs/`      | Map thumbnails, typically autogenerated                           |
|`│  └─ templates/`         |                                                                   |
|`│     └─ legendprint.html`| HTML template for the legend print                                |
|`├─ js/`                   |                                                                   |
|`│  ├─ app.jsx`            | Entry point of the ReactJS application                            |
|`│  ├─ appConfig.js`       | Configuration of the qwc2 core modules                            |
|`│  ├─ EditingInterface.js`| Interface to the service for editing features, see [EditingInterface.js](#implementing-the-editing-interface-in-jseditinginterfacejs). |
|`│  ├─ Help.jsx`           | Component for rendering a user-defined Help dialog                |
|`│  └─ SearchProviders.js` | Search providers                                                  |
|`├─ icons/`                | Application icons                                                 |
|`├─ qwc2/`                 | Git submodule containing the core qwc2 components                 |
|`├─ translations/`         | Translation files                                                 |
|`├─ config.json`           | Master configuration file                                         |
|`├─ index.html`            | Entry point                                                       |
|`├─ package.json`          | NodeJS configuration file                                         |
|`├─ styleConfig.json`      | Configuration of some application-wide styles                     |
|`├─ themesConfig.json`     | Themes configuration                                              |
|`├─ themes.json`           | Full theme configuration, autogenerated from `themesConfig.json`. |
|`└─ webpack.config.js`     | Webpack dev server and application bundler configuration          |

These files are described in detail in the following sections, in order of importance.

## Application configuration: the `config.json` and `js/appConfig.js` files

The central aspect to keep in mind is that a QWC2 application consists of a collection of plugins, which can be individually enabled and configured, in particular separately for desktop and mobile mode. Together, the `config.json` and `js/appConfig.js` files control these plugins, along with a number of other global settings.

The `js/appConfig.js` is the build-time configuation file, and defines:
- The default application locale, built into the application. This locale is used if no available locale matches the browser locale.
- Which plugins are built into the application. Plugins left out here will be completely omitted when compiling the application bundle, and will hence also reduce the size of the bundle.
- Various hook functions, as documented in the sample [sample `js/appConfig.js`](https://github.com/qgis/qwc2-demo-app/blob/master/js/appConfig.js).

The `config.json` file is the run-time configuration file. It contains the following settings:

*URLs of external services*:
Some external services can be used to enhance the application. The reference implementation of these services are hosted at [https://github.com/qwc-services/](https://github.com/qwc-services/). The following services can be configured:

| Setting              | Description |
|----------------------|-------------|
|`proxyServiceUrl`     | Ensures replies from cross-origin requests contain the CORS header. See [Cross-Origin requests](server_side_configuration.md#cross-origin-requests).|
|`permalinkServiceUrl` | Generates and resolves compact permalinks for the Share plugin. If omitted, the full URL will be used. |
|`elevationServiceUrl` | Returns elevation values, used to generate a height profile when measuring lines and display elevation information in the map right-click information bubble. If omitted, the respective information will not be displayed in the client.|
|`mapInfoService`      | Returns additional information to be displayed in the map right-click information bubble. If omitted, no additional information will be displayed.|
|`featureReportService`| Returns a custom document associated to a feature. See [`themesConfig.json`](#configuring-the-themes-in-themesconfigjson).|

*Global settings*:

All settings are optional, with fallback to the default values as documented.

| Setting                             | Description |
|-------------------------------------|-------------|
|`translationsPath`                   | Path from the webserver root to the `translations` folder.                          |
|`assetsPath`                         | Path from the webserver root to the `assets` folder.                                |
|`urlPositionFormat`                  | How to encode the current map extent in the URL, either `centerAndZoom` or `extent`. See [URL parameters](url_parameters.md) for details. |
|`urlPositionCrs`                     | The CRS used to encode the current map extent coordinates in the URL.               |
|`omitUrlParameterUpdates`            | Whether to omit updating the URL parameters.                                        |
|`defaultFeatureStyle`                | The default style to use for selection geometries and other unstyled features.      |
|`projections`                        | A list of additional projections to register, in the format `{"code": "<code>", "proj": "<proj4def>", "label": "<label>"}`. |
|`allowFractionalZoom`                | Whether to allow arbitrary scales for viewing the map.                              |
|`localeAwareNumbers`                 | Whether to use locale aware numbers throughout.                                     |
|`wmsDpi`                             | The DPI to pass to the WMS requests.                                                |
|`wmsHidpi`                           | Whether to honour the device pixel ratio for WMS GetMap requests.                   |

*Global settings, overridable per theme*:<a name="config-json-overridable"></a>

The following options can be specified globally, and also overriden per theme, see [`themesConfig.json`](#configuring-the-themes-in-themesconfigjson).

| Setting                              | Description |
|--------------------------------------|-------------|
|`preserveExtentOnThemeSwitch`         | Whether to preserve the current map extent when switching theme, if possible (see below). Default value: `false`. |
|`preserveBackgroundOnThemeSwitch`     | Whether to preserve the current background layer when switching theme, if possible. Default value: `false`. |
|`preserveNonThemeLayersOnThemeSwitch` | Whether to preserve non-theme layers when switching theme. Default value: `false`.  |
|`allowReorderingLayers`               | Whether to allow re-ordering layers in the layer tree. Default value: `false`.      |
|`flattenLayerTreeGroups`              | Whether to display a flat layer tree, omitting the groups. Default value: `false`.  |
|`allowLayerTreeSeparators`            | Allows users to add separator items in a flat layer tree. Default value: `false`.   |
|`preventSplittingGroupsWhenReordering`| Whether to prevent splitting sibling groups or the group itself when reordering items. Default value: `false`. |
|`allowRemovingThemeLayers`            | Whether to allow removing any theme layers from the layer tree. Default value: `false`. |
|`searchThemes`                        | Whether allow searching for themes from the global search field. Default value: `false`. |
|`allowAddingOtherThemes`              | Whether to allow adding another theme to a currently loaded theme. Default value: `false`. |
|`disableImportingLocalLayers`         | Whether to hide the option to import local layers from the layer tree. Default value: `false`. |
|`importLayerUrlPresets`               | A list of predefined URLs from which the user can choose when importing layers from the layer tree. Entries must be strings or objects of the format `{"label": "<Label>", "value": "<URL>"}`. See also [Layer catalogs](#layer-catalogs). |
|`identifyTool`                        | The name of the identify plugin to use. It is possible to have multiple identify tools, and i.e. on a per-theme basis select which one is active. Default value: `Identify`. |
|`globallyDisableDockableDialogs`      | Whether to globally disable the dockable feature of popup dialogs. Default value: `false`. |

*Notes*:

- The layer tree supports re-ordering layers via drag-and-drop if `allowReorderingLayers = true` *and either* `preventSplittingGroupsWhenReordering = true` *or* `flattenLayerTreeGroups = true`.
- If `preserveExtentOnThemeSwitch = true`, the current extent is preserved if it is within the new theme extent and if the current theme map projection is equal to the new theme projection. If `preserveExtentOnThemeSwitch = "force"`, the current extent is preserved regardless of whether it is within the new theme extent, but the current and new theme map projections must still match.

*Plugin configuration*:<a name="config-json-plugin-conf"></a>
The plugin configuration is entered separately for desktop and for mobile mode. Refer to the [sample `config.json`](https://github.com/qgis/qwc2-demo-app/blob/master/static/config.json) for a list of available configuration options. Each plugin configuration block is of the format

    {
      "name": "<PluginName">,
      "cfg": {
        ...
      },
      "mapClickAction": <"identify"|"unset"|null>
    }

where

* `name`: The plugin name
* `cfg`: Optional: arbitrary configuration properties, directly passed to the relative plugin class as React props.
* `mapClickAction`: Optional: for plugins which are associated to a viewer task (and typically linked in the `menuItems` or `toolbarItems` of the `TopBar`, see below), determines whether a click in the map will result in the identify tool being invoked, the task being unset, or whether no particular action should be performed (default). Note: `"mapClickAction"` should be `null` or omitted for plugins which handle mouse events on the map themselves. Can optionally also be specified directly in the `menuItems` or `toolbarItems` entries, see below.

You can omit a plugin entry to disable it in desktop and/or mobile mode. To completely remove a plugin from the compiled application, remove the corresponding entry in `js/appConfig.js`.

A particularly interesting aspect is the configuration of the entries in the application menu and toolbar, i.e. the entries in `menuItems` and `toolbarItems` in the `TopBar` configuration. The most common format for linking an entry to an existing plugin is

    {"key": "<key>", "icon": "<icon>", "themeWhitelist": ["<themename>", ...], "mapClickAction": <"identify"|"unset"|null>, "mode": "<mode>", "requireAuth": <true|false>, "shortcut: "<shortcut>"}

where

* `key`: The name of the plugin to activate when the entry is clicked, i.e. `LayerTree`. Also used to lookup the label for the entry from the translations, using the `appmenu.items.<key>` message identifier (see <a href="#translations">Managing translations</a>).
* `icon`: The icon of the entry, either a name (without the `.svg` extension) of an icon in `icons/`, or `:/<path_to_asset>` containing the path relative to `assetsPath` of an asset image.
* `themeWhitelist`: Optional, allows specifying a whitelist of theme names or titles for which the entry should be visible.
* `mapClickAction`: Optional, takes precedence over the `mapClickAction` setting specified in the plugin configuration block, if any. See above.
* `mode`: Optional, depending on the plugin, a mode can be configured to launch the plugin directly in a specific mode. For instance, the `Measure` plugin supports specifying the measurement mode (`Point`, `LineString`, `Polygon`).
* `requireAuth`: Optional, the entry is only visible when user is logged-in when true (works with qwc-services).
* `shortcut`: Optional, keyboard shortcut which triggers the entry

Additionally, entries opening external URLs can be defined as follows:

    {"key": "<key>", "icon": "<icon>", "url": "<url>", "target": "<target>"}

where

* `Key`: An arbitrary key name (not used by existing plugins), used to lookup the label for the entry from the translations.
* `icon`: As above.
* `url`: The URL to open. Can contain as placeholders the keys listed in <a href="#url-parameters">URL parameters</a>, encolsed in `$` (i.e. `$e$` for the extent). In addition, the placeholders `$x$` and `$y$` for the individual map center coordinates are also supported.
* `target`: The target where to open the URL, if empty, `_blank` is assumed. Can be `iframe` to open the link in a iframe window inside QWC2.



## Theme configuration: QGIS projects and the `themesConfig.json` file

A theme corresponds to a QGIS project, published as WMS and served by QGIS Server.

### Creating and publishing a QGIS project

The first step is to prepare a QGIS project. Besides the common tasks of adding and grouping layers, the following table gives an overview of settings which influence how the theme is displayed by QWC2:

| What                 | Where                                     | Description                                      |
|----------------------|-------------------------------------------|--------------------------------------------------|
| Service capabilities | Project Properties &rarr; QGIS Server &rarr; Service capabilities | **Must** be checked for QGIS Server to publish the project. |
| Service Metadata     | Project Properties &rarr; QGIS Server &rarr; Service capabilities | Shown in the theme info dialog, invokable from the Layer Tree panel titlebar. |
| Title, keywords      | Project Properties &rarr; QGIS Server &rarr; Service capabilities | Theme title, displayed in the Theme Switcher, and keywords, useful for filtering. |
| Queryable layers     | Project Properties &rarr; Data sources | Mark layers as identifyable by the client.       |
| FeatureInfo geometry | Project Properties &rarr; QGIS Server &rarr; WMS Capabilities &rarr; Add geometry to feature response | Return feature geometries with the GetFeatureInfo request. Allows the client to highlight the selected features. |
| Layer Display Field  | Vector Layer Properties &rarr; Display    | The field used in the identify results. |
| Layer Map Tip        | Vector Layer Properties &rarr; Display    | The contents of the Map Tip shown when hovering over layers in the client, if displaying Map Tips is enabled in the Layer Tree. |
| Layer Metadata       | Layer Properties &rarr; QGIS Server       | Shown in the client Layer Info dialog, invokable from the Layer Tree. |
| Scale range          | Layer Properties &rarr; Rendering &rarr; Scale dependent visibility | The scale range within which a layer is visible, useful to improve rendering performance. |
| Initial visibility   | Layers Panel                              | Initial visibility of layers and groups.         |
| Rendering order      | Layer Order Panel or Layers Panel         | Rendering order of the layers. If layer re-ordering is enabled in `config.json`, the order from the Layer Order Panel is ignored. |
| Print layouts        | Layout manager                            | The print layouts offered in the Print plugin.   |
| Print layout labels  | Layout manager                            | Print layout labels with an ID will be exposed in the Print plugin. Note: a label ID starting with `__` will not be exposed. |

### Configuring the themes in `themesConfig.json`

The second step is to configure the themes which are available to QWC2 in the `themesConfig.json` file, which contains a list of themes, optionally organized in groups, as well as a list of background layers:

    {
      "themes": {
        "items": [
          { <ThemeDefinition> },
          ...
        ], "groups": [
          {
            "title": <Group title>,
            "items": [{ <ThemeDefinition> }, ...],
            "groups": [ { <Group> }, ...]
           },
           ...
        ]
      },
      "externalLayers": [
        { <ExternalLayerDefinition> },
        ...
      ],
      "themeInfoLinks": [
        { <ThemeInfoLinkDefinition> },
        ...
      ],
      "backgroundLayers": [
        { <BackgroundLayerDefinition> },
        ...
      ],
      "defaultScales": [<Scale denominators>],
      "defaultPrintScales" [<Scale denominators>],
      "defaultPrintResolutions": [<DPIs>],
      "defaultPrintGrid": [<Print grid, see below>]
    }

Refer to the [sample `themesConfig.json`](https://github.com/qgis/qwc2-demo-app/blob/master/themesConfig.json) for a complete example.

The format of the theme definitions is as follows:
<!-- Important: Use U+00A0 non-breaking spaces ( ) in code blocks -->
| Entry                                        | Description                                                                       |
|----------------------------------------------|-----------------------------------------------------------------------------------|
| `"url": "<WMS URL>",`                        | The address of desired WMS served by QGIS Server.                                 |
| `"wmsBasicAuth": "{`                         | Optional, allows to authenticate to QGIS Server during themes.json generation. NOTE: these credentials will solely be used by `yarn run themesConfig` and won't be stored in `themes.json`.|
| `  "username": <username>`                   | Optional: http basic authentication username.                                     |
| `  "password": <password>`                   | Optional: http basic authentication password.                                     |
| `},`                                         |                                                                                   |
| `"title": "<Custom title>",`                 | Optional, override WMS title.                                                     |
| `"description": "<Description>",`            | Optional, an additional description to show below the theme title.                |
| `"thumbnail": "<Filename>",`                 | Optional, image file in `assets/img/mapthumbs`. If omitted, autogenerated via WMS GetMap. |
| `"attribution": "<Attribution>",`            | Optional, attribution which will be shown in the bottom right corner of the map.  |
| `"attributionUrl": "<URL>",`                 | Optional, link associated to the attribution                                      |
| `"default": true,`                           | Whether to use this theme as initial theme                                        |
| `"scales": [<Scale denominators>],`          | List of denominators of allowed map scales. If omitted, defaults to `defaultScales`. |
| `"printScales": [<Scale denominators>],`     | List of denominators of allowed print scales. If omitted, defaults to `defaultPrintScales`. |
| `"printResolutions": [<DPIs>],`              | List of available print resolutions. If omitted, defaults to `defaultPrintResolutions`. |
| `"printGrid": [`                             | List of grid scale-dependent grid intervals to use when printing. If omitted, defaults to `defaultPrintGrid`. |
| `  {"s": <Scale1>, x: <Interval1>, y: <Interval1>},` | Keep this list sorted in descending order by scale denominator.           |
| `  {"s": <Scale2>, x: <Interval2>, y: <Interval2>}`  | In this example, `{x: <Interval2>, y: <Interval2>}` will be used for `<Scale1> > Scale >= <Scale2>`.  |
| `],`                                          |                                                                                  |
| `"printLabelForSearchResult": "<ID>",`        | Optional, an ID of a print layout label to which the current search result text (if any) will be written to when printing. |
| `"printLabelForAttribution": "<ID>",`         | Optional, an ID of a print layout label to which the current attribution text (if any) will be written to when printing. |
| `"printLabelConfig": {`                       | Optional, configuration of the text input fields for print layout labels.        |
| `  "<LabelId>": {"rows": <n>, "maxLength": <n>},` | Height of the input field in rows and maximum number of allowed characters.  |
| `},`                                          |                                                                                  |
| `"mapCrs: "<EPSG code>",`                     | Optional, map projection, defaults to `EPSG:3857`.                               |
| `"extent": [<xmin>, <ymin>, <xmax>, <ymax>],` | Optional, override theme extent. In `mapCrs`.                                    |
| `"tiled": <boolean>,`                         | Optional, use tiled WMS, defaults to `false`.                                    |
| `"format": "<mimetype>",`                     | Optional, the format to use for WMS GetMap. Defaults to `image/png`.             |
| `"externalLayers": [{`                        | Optional, external layers to use as replacements for internal layers, see below. |
| `  "name": "<external_layer_name>",`          | Name of the external layer, matching a `ExternalLayerDefinition`, see below.     |
| `  "internalLayer": "<QGis_layer_name>"`      | Name of an internal layer, as contained in the QGIS project, to replace with the external layer. |
| `}],`                                         |                                                                                  |
| `"themeInfoLinks": {`                         | Optional, custom links to additional resources, shown as a menu in the theme selector in the theme switcher.\
| `  "title": "<Menu title>",`                  | An arbitrary string shown as title of the menu.                                  |
| `  "titleMsgId": "<Menu title msgID>",`       | Alternative to `title`, a message ID, translated through the translation files.  |
| `  "entries": [<link_name>, ...]`             | List of theme info link names, see below.                                        |
| `},`                                          |                                                                                  |
| `"backgroundLayers": [{,`                     | Optional, list of available background layers.                                   |
| `  "name": "<Background layer name>",`        | Name of matching `BackgroundLayerDefinition`, see below.                         |
| `  "printLayer": "<QGis layer name>"\|[<list>],`| Optional, name of layer to use as matching background layer when printing. Alternatively, a list `[{"maxScale": <scale>, "name": "<QGis layer name>"}, ..., {"maxScale": null, "name": "<QGis layer name>"}]` can be provided, ordered in ascending order by `maxScale`. The last entry should have `maxScale` `null`, as the layer used for all remaining scales. If omitted, no background is printed, unless layer is of type "wms" and `printExternalLayers` is `true` in the Print plugin configuration. |
| `  "visibility": <boolean>`,                  | Optional, initial visibility of the layer when theme is loaded.                  |
| `  "overview": <boolean>`,                    | Optional, set the layer as the overview map layer (i.e. this layer will be displayed in the overview map regardless of the background layer visible in the main map).                  |
| `}],`                                         |                                                                                  |
| `"searchProviders": ["<Provider>"],`        | Optional, list of search providers, see [Search providers](#search-providers).     |
| `"minSearchScaleDenom": <number>,`                 | Optional, minimum scale to enforce when zooming to search results. Takes precedence over value in `config.json`. |
| `"featureReport": {`                          | Optional, available feature report templates.                                    |
| `  "<LayerId>": "<TemplateID>"  `             | WMS sublayer ID and associated template ID to pass to the `featureReportService`.|
| `},`                                          |                                                                                  |
| `"additionalMouseCrs": ["<EPSG code>"],`      | Optional, list of additional projections for displaying the mouse position. WGS84 and `mapCrs` are available by default. Additional projections definitions must be added to `js/appConfig.js` or `config.json`.         |
| `"watermark": {`                              | Optional, configuration of watermark to add to raster export images.             |
| `  "text": "<text>",`                         | Arbitrary text.                                                                  |
| `  "texpadding": <number>,`                   | Optional, padding between text and frame, in points.                             |
| `  "fontsize": <number>,`                     | Optional, font size.                                                             |
| `  "fontfamily": "<Font family>",`            | Optional, font family.                                                           |
| `  "fontcolor": "#RRGGBB",`                   | Optional, font color.                                                            |
| `  "backgroundcolor": "#RRGGBB",`             | Optional, frame background color.                                                |
| `  "framecolor": "#RRGGBB",`                  | Optional, frame color.                                                           |
| `  "framewidth": <number>,`                   | Optional, frame width.                                                           |
| `},`                                          |                                                                                  |
| `"collapseLayerGroupsBelowLevel": <level>,`   | Optional, layer tree level below which to initially collapse groups. By default the tree is completely expanded. |
| `"skipEmptyFeatureAttributes": <boolean>,`    | Optional, whether to skip empty attributes in the identify results. Default is `false`. |
| `"mapTips":  <boolean>\|null,`                | Optional, per-theme setting whether map-tips are unavailable (`null`), disabled by default (`false`) or enabled by default (`true`). |
| `"extraLegendParameters": "<&KEY=VALUE>",`    | Optional, additional query parameters to append to WMS GetLegendGraphic.         |
| `"printLabelBlacklist":  ["<LabelId>", ...]`  | Optional, list of composer label ids to not expose in the print dialog. |
| `"editConfig": "<editConfig.json>"`           | Optional, object or path to a filename containing the editing configuration for the theme, see [Editing](#editing). |
| `"snapping": {...},`                          | Optional, snapping configuration, see [Snapping](#snapping). |                   |
| `"config": {`                                 | Optional, per-theme configuration entries which override the global entries in `config.json`.|
| `  "allowRemovingThemeLayers": <boolean>`     | See [`config.json`](#config-json-overrideable) for which settings can be specified here. |
| `  ...`                                       |                                                                                  |
| `}`                                           |

**External layers:**
External layers can be used to selectively replace layers in a QGIS project, for instance in the case of a WMS layer embedded in a QGIS project, to avoid cascading WMS requests. They are handled transparently by QWC2 (they are positioned in the layer tree identically to the internal layer they replace), but the `GetMap` and `GetFeatureInfo` requests are sent directly to the specified WMS Service.

The format for external layer definitions is as follows:

| Entry                                                  | Description                                                                       |
|--------------------------------------------------------|-----------------------------------------------------------------------------------|
| `"name": "<external_layer_name>",`                     | The name of the external layer, as referenced in the theme definitions.           |
| `"type": "<layer_type>",`                              | Layer type, "wms" or "wmts"                                                       |
| `"url": "<wms_baseurl>",       `                       | The WMS URL or WMTS resource URL for the external layer.                          |

For external WMS layers, the following additional parameters apply:

| Entry                                                  | Description                                                                       |
|--------------------------------------------------------|-----------------------------------------------------------------------------------|
| `"params": {`                                          | Parameters for the GetMap request.                                                |
| `  "LAYERS": "<wms_layername>,..."`,                   | WMS layer names.                                                                  |
| `  "OPACITIES": "<0-255>,..."`                         | Optional, if WMS server supports opacities.                                       |
| `},`                                                   |                                                                                   |
| `"featureInfoUrl": "<wms_featureinfo_baseurl>",`       | Optional, base URL for WMS GetFeatureInfo, if different from `url`.               |
| `"legendUrl": "<wms_legendgraphic_baseurl>"   ,`       | Optional, base URL for WMS GetLegendGraphic, if different from `url`.             |
| `"queryLayers": ["<wms_featureinfo_layername>", ...],` | Optional, list of GetFeatureInfo query layers, if different from `params.LAYERS`. |
| `"infoFormats": ["<featureinfo_format>", ...]`         | List of GetFeatureInfo query formats which the WMS service supports.              |

For external WMTS layers, the following additional parameters apply (you can use the `qwc2/scripts/wmts_config_generator.py` script to obtain these values):

| Entry                                                  | Description                                                                       |
|--------------------------------------------------------|-----------------------------------------------------------------------------------|
| `"tileMatrixSet": "<tile_matrix_set_name>",`           | The name of the tile matrix set.                                                  |
| `"originX": <origin_x>,`                               | The X origin of the tile matrix.                                                  |
| `"originY": <origin_y>,`                               | The Y origin of the tile matrix.                                                  |
| `"projection": "EPSG:<code>",`                         | The layer projection.                                                             |
| `"resolutions": [<resolution>, ...],`                  | The list of WMTS resolutions.                                                     |
| `"tileSize": [<tile_width>, <tile_height>]`            | The tile width and height.                                                        |

You can also set the "Data Url" for a layer in QGIS (Layer Properties &rarr; QGIS Server &rarr; Data Url) to a string of the form

    wms:<service_url>?<options>#<layername>

(for instance, `wms:http://wms.geo.admin.ch?tiled=false#ch.are.bauzonen`), and an external layer pointing to the specified WMS service will automatically be created for the corresponding QGIS layer.
Note that this is currently only implemented for WMS layers.


**Theme info links:**
You can specify links to display in an info-menu next to the respective theme title in the theme switcher entries.

The format for the theme info links is as follows:

| Entry                                                  | Description                                                                       |
|--------------------------------------------------------|-----------------------------------------------------------------------------------|
| `"name": "<link_name>",`                               | The name of the link, as referenced in the theme definitions.                     |
| `"title": "<link_title>",`                             | The title for the link, as displayed in the info menu of the theme entry in the theme switcher. |
| `"url": "<link>",`                                     | A link URL.                                                                       |
| `"target": "<link_target>"`                            | The link target, i.e. `_blank`.                                                   |


**Background layers:**
Background layers are handled completely client-side and do not appear in the layer tree.

The format of the background layer definitions is as follows:

| Entry                                 | Description                                                                       |
|---------------------------------------|-----------------------------------------------------------------------------------|
| `"name": "<Name>",`                   | The name of the background layer, used in the theme definitions.                  |
| `"title": "<Title>",`                 | The title of the background layer, as displayed in the background switcher.       |
| `"titleMsgId": "<Menu title msgID>",` | Alternative to `title`, a message ID, translated through the translation files.  |
| `"thumbnail": "<Filename>",`          | Optional, image file in `assets/img/mapthumbs`. Defaults to `default.jpg`.        |
| `"type": "<Type>",`                   | The background layer type, i.e. `wms` or `wmts`.                                  |
| `"group":  "<GroupId>",`              | Optional, a group ID string. Background layers with the same group ID will be grouped together in the background switcher. |
| `"minScale": <min_scale>,`            | Optional, minimum scale denominator from which to render the layer.               |
| `"maxScale": <max_scale>,`            | Optional, maximum scale denominator from which to render the layer.               |
| `<Layer params>`                      | Parameters according to the specified layer type. Refer to the [sample `themesConfig.json`](https://github.com/qgis/qwc2-demo-app/blob/master/themesConfig.json) for some examples. |

*Note*: You can use the helper python script located at `qwc2/scripts/wmts_config_generator.py` to easily generate WMTS background layer configurations.

### Generating `themes.json`

The final step is to generate `themes.json`, the file which is ultimately read by QWC2. This file combines the input from `themesConfig.json` with the information from the WMS service capabilities and is automatically generated when starting the local development application via `yarn start`. Alternatively, it can be manually generated via

    yarn run themesconfig

or, if working in an environment without node, using the equivalent command

    python3 qwc2/scripts/themesConfig.py


If you want to manage multiple `themesConfig.json` files, you can specify which while should be processed by the theme generation script via the `QWC2_THEMES_CONFIG` environment variable.

Note: if you are behind a proxy server and your `themesConfig.json` refers to resources outside the local network, you'll need to specify the proxy settings to use in `themesConfig.json` by adding a toplevel block of the form

    {
      "proxy": {
          "host": "<host>",
          "port": <port>,
          "auth": {
              "username": "<username>",
              "password": "<password>"
        }
      },
      "themes": {...},
      ...
    }

## Implementing search providers in `js/SearchProviders.js`

### Adding search providers

Search providers can be defined as follows:

- Built-in, defined in `js/SearchProviders.js`. This file is structured as follows:

      export const SearchProviders = {
          <providerkey1>: <ProviderDefinition1>,
          <providerkey2>: <ProviderDefinition2>,
          ...
      };

## Implementing the editing interface in `js/EditingInterface.js`

- As resource, defined in `static/assets/searchProviders.js`. This file is structured as follows:

      window.QWC2SearchProviders = {
          <providerkey1>: <ProviderDefinition1>,
          <providerkey2>: <ProviderDefinition2>,
          ...
      };

  This script file needs to be loaded explicitly by `index.html` via

      <script type="text/javascript" src="assets/searchProviders.js" ></script>

The format of `ProviderDefinition` is

    {
      label: "<human readable provider name>", // OR
      labelmsgid: "<translation message ID for human readable provider name>",
      onSearch: function(searchText, searchParams, callback, axios) => {
        const results = []; // See below
        /* Populate results... */
        callback({results: results});
      },
      getResultGeometry: function(resultItem, callback, axios) => {
        /* Retreive geometry... */
        // resultItem is a search result entry as returned by onSearch, which provides the context for retreiving the geometry
        const geometry = "<wktString>";
        const crs = "EPSG:XXXX";
        const hidemarker = <boolean>; // Whether to suppress displaying a search marker on top of the search geometry
        callback({geometry: wktString, crs: crs, hidemarker: hidemarker});
      }
    }

Notes:

* The format of `searchParams` is

      {
        displaycrs: "EPSG:XXXX", // Currently selected mouse coordinate display CRS
        mapcrs: "EPSG:XXXX", // The current map CRS
        lang: "<code>", // The current application language, i.e. en-US or en
        cfgParams: <params> // Additional parameters passed in the theme search provider configuration, see below
      }

* `axios` is passed for convenience so that providers can use the compiled-in `axios` library for network requests.

* The format of the `results` list returned by `onSearch` is as follows:

      results = [
        {
          id: "<categoryid>",                   // Unique category ID
          title: "<display_title>",             // Text to display as group title in the search results
          priority: priority_nr,                // Optional: search result group priority. Groups with higher priority are displayed first in the list.
          items: [
            {                                   // Location search result:
              type: SearchResultType.PLACE,     // Specifies that this is a location search result
              id: "<itemId">,                   // Unique item ID
              text: "<display text>",           // Text to display as search result
              label: "<map marker text>",       // Optional, text to show next to the position marker on the map instead of `text`
              x: x,                             // X coordinate of result
              y: y,                             // Y coordinate of result
              crs: crs,                         // CRS of result coordinates and bbox
              bbox: [xmin, ymin, xmax, ymax]    // Bounding box of result (if non-empty, map will zoom to this extent when selecting result)
            },
            {                                    // Theme layer search result (advanced):
              type: SearchResultType.THEMELAYER, // Specifies that this is a theme layer search result
              id: "<itemId">,                    // Unique item ID
              text: "<display text>",            // Text to display as search result
              layer: {<Layer definition>}        // Layer definition, in the same format as a "sublayers" entry in themes.json.
            }
          ]
        },
        {
          ...
        }
      ]

Consult [js/SearchProviders.js](https://github.com/qgis/qwc2-demo-app/blob/master/js/SearchProviders.js) and [static/assets/searchProviders.js](https://github.com/qgis/qwc2-demo-app/blob/master/static/assets/searchProviders.js) for full examples.

### Configuring theme search providers

For each theme item in `themesConfig.json`, you can define a list of search providers to enable for the theme as follows:

    ...
    searchProviders: [
      "<providerkey1>",             // Simple form
      {                             // Provider with custom params
        key: "<providerkey2>",
        params: {
          ...                       // Arbitrary params passed to the provider `onSearch` function as `searchParams.cfgParams`
        }
      },
      {                             // Fulltext search configuration using qwc-fulltext-search-service
        "provider":"solr",          // Identifier for solr search provider
        "default":[<default terms>] // Default search terms, concatenated with additional search terms from visible theme layers
      }
    ],
    ...

For more information on the full-text search provider, see [qwc-fulltext-search-service](https://github.com/qwc-services/qwc-fulltext-search-service).

## <a name="editing"></a>Editing support

QWC2 offers comprehensive editing support through a variety of plugins:

- The `Editing` plugin allows creating, editing and removing features of an editable vector layer. It supports editing both geometry and attributes, displaying customizeable attribute forms.
- The `AttributeTable` plugin also allows creating, editing and removing features of an editable vector layer. It displays all features of the editable layer in a tabularized view, and allows editing attributes, but not geometries.
- The `FeatureForm` works similarly to the feature-info, but also allows editing the attributes and geometry of a picked feature. It can be used as `identifyTool` instead of the standard `Identify` plugin.

To configure editing in QWC2, you need to follow the following steps:

- Set up an editing backend. You can use the readily available [QWC data service](https://github.com/qwc-services/qwc-data-service), or a custom backend.
- Enable the desired editing plugins in `appConfig.js`. If you use a custom editing backend, you'll most likely need to implement a custom editing interface and specify it in `appConfig.json`, see the comment above `EditingPlugin` in [`js/appConfig.js`](https://github.com/qgis/qwc2-demo-app/blob/master/js/appConfig.js).
- If you are using qwc-services, the [QWC config generator](https://github.com/qwc-services/qwc-config-generator) and [QWC map viewer](https://github.com/qwc-services/qwc-map-viewer) will automatically generate a suitable `editConfig` for each editable layer and embed it in the `themes.json`, otherwise you need to write a custom `editConfig` in `themesConfig.json` as described below.

As a backend, you can use the readily available [QWC data service](https://github.com/qwc-services/qwc-data-service). Please consult its README detailed information including how to set up the edit forms.

If you use a custom backend, you will need to implement a corresponding editing interface in `js/EditingInterface.js`.

If you don't use the [QWC config generator](https://github.com/qwc-services/qwc-config-generator) and [QWC map viewer](https://github.com/qwc-services/qwc-map-viewer), you will also need to write the `editConfig` block in `themesConfig.json` as follows:

| Entry                                | Description                                                   |
|--------------------------------------|---------------------------------------------------------------|
| `{`                                  |                                                               |
| `  <LayerId>: {`                     | A WMS layer ID. Should be a theme WMS layer name, to ensure the WMS is correctly refreshed. |
| `    "layerName": "<LayerName>",`    | The layer name to show in the selection combo box. |
| `    "editDataset": "<DatasetName>",`| The name of the edit dataset passed to the editing interface. |
| `    "geomType": "<GeomType>",`      | The geometry type, either `Point`, `LineString` or `Polygon`. |
| `    "displayField":  "<FieldId>",`  | The ID of the field to use in the feature selection menu.     |
| `    "permissions": {`               | A list of different write permissions to specify rights and buttons. |
| `      "creatable": <boolean>,`      | If `true`, `Draw` button will appear in Editing interface and `Add` button in Attribute Table. |
| `      "updatable": <boolean>,`      | If `true`, `Pick` button will appear in Editing interface.    |
| `      "deletable": <boolean>,`      | If `true`, `Delete` button will appear in Editing interface and Attribute Table. |
| `      },`                           |                                                               |
| `    "fields": [{`                   | A list of field definitions, for each exposed attribute.      |
| `      "id": "<FieldID>",`           | The field ID.                                                 |
| `      "name": "<FieldName>",`       | The field name, as displayed in the editing form.             |
| `      "type": "<FieldType>",`       | A field type. Either `bool`, `list` or a regular [HTML input element type](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input). |
| `      "constraints": {`             | Constraints for the input field.                              |
| `        "values": [<Entries>],`     | Only if `type` is `list`: an array of arbitrary strings.      |
| `        ...`                        | For regular HTML input types, the ReactJS API name of any applicable [HTML input constraint](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input), i.e. `maxLength` or `readOnly`. |
| `      }`                            |                                                               |
| `    }],`                            |                                                               |
| `    "form": "<PathToUiFile>",`      | As alternative to `fields`, a QtDesigner UI file. See below.  |
| `  }`                                |                                                               |
| `}`                                  |                                                               |

* If you specify `fields`, a simple form is autogenerated based on the field definitions.
* If you specify `form`, you can specify the URL to a Qt Designer UI form (use `:/<path>` to specify a path below the `assets` folder). Most basic input elements provided by QtDesigner are supported, see [this sample form](https://github.com/qgis/qwc2-demo-app/blob/master/assets/forms/form.ui). The widget names must be set equal to the attribute names.

See the [sample `editConfig.json`](https://github.com/qgis/qwc2-demo-app/blob/master/test2056_edit.json) for a full example.

## <a name="translations"></a>Managing translations

The translations are managed on two levels:

- At QWC2 components level, in `qwc2/translations`.
- At application level, in `translations`.

A script will take care of merging the component translations into the application translations. This way, when updating the QWC2 submodule, new translations are automatically obtained. This script is automatically invoked on `yarn start`, but can also be manually invoked using

    yarn run tsupdate

Translations are stored inside the respective `translations` folder as regular plain-text JSON files, named `<locale>.json` and can be freely edited with any text editor.

The `tsconfig.json` files stored inside the respective `translations` folder contains the list of languages for which translations should be generated and a list of message IDs to include in the translation. The `tsupdate` script will automatically scan for message IDs (looking for static strings passed to `LocaleUtils.tr` and `LocaleUtils.trmsg`), store these in `tsconfig.json` and automatically create resp. update the translation files.

In some cases `tsconfig.json` will not pick up a message ID (for instance, if it is computed at runtime). In these cases, the message IDs can be added manually to the `extra_strings` section of the `tsconfig.json`.

Also it may be desired to override a translation inherited from the QWC2 components at application level. To prevent `tsupdate` from continuously reverting the overridden translation, the respective message IDs can be added to the `overrides` section in the application `tsconfig.json` file.

The typical workflow for managing application translations is:

- Declare all locales which should be supported in `js/appConfig.js`.
- Ensure these locales are listed in `translations/tsconfig.json`.
- Write the translated strings to the respective `<locale>.json` files.
- Test the translation, specifying `lang=<locale>` in the QWC2 application URL.

If translations of the QWC2 components for a desired language are missing, please create resp. update the translations respective files in `qwc2/translations` and contribute them by submitting a pull request to the [upstream qwc2 repository](https://github.com/qgis/qwc2).

## <a name="appearance-customization"></a>Customizing the QWC2 appearance

The following options are available for customizing the appearance of the QWC2 application while preserving compatibility with the core QWC2 components:

- Modifying the logo in `assets/img/`.
- Modifying the application icons in `icons`.
- Defining new color schemes, see [Color schemes](#color-schemes).
- Adding style declarations to the master CSS stylesheet `assets/css/qwc2.css`. This however is potentially fragile and should only be done as a last resort.
- Changing the browser page title in `index.html`, and potentially adding a favicon.
- Modifying the legend print template in `assets/templates/legendprint.html`. The only requirement for this template is that is must contain a `<div id="legendcontainer"></div>` element.
- Implementing the Help component, see [Help dialog](#help-dialog).

*Note*: The common application icons are located in `qwc2/icons`. They can be overridden by creating an icon with the same filename in the application specific `icons` folder.
*Note*: The icons in the `icons` folder are compiled into an icon font. Currently, the icons need to be black content on transparent background, and all drawings (including texts) must be converted to paths for the icons to render correctly.
